<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>节气海报生成 - AI溯源智养</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>

    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-leaf"></i> 溯源智养
            </div>
            <div class="mobile-menu-btn" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">首页</a>
                <a href="assessment.html" class="nav-link">体质测评</a>
                <a href="advisor.html" class="nav-link">AI顾问</a>
                <a href="poster.html" class="nav-link active">节气海报</a>
                <a href="ingredients.html" class="nav-link">食材图鉴</a>
                <a href="recipes.html" class="nav-link">食谱生成</a>
                <a href="account.html" class="nav-link">个人中心</a>
            </div>
        </div>
    </nav>

    <!-- 移动端侧边栏 -->
    <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>
    <div class="mobile-drawer">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div class="logo" style="font-size: 1.2rem;"><i class="fas fa-leaf"></i> 溯源智养</div>
            <div onclick="toggleMobileMenu()" style="font-size: 1.5rem; color: #666;"><i class="fas fa-times"></i></div>
        </div>
        <a href="index.html" class="nav-link">首页</a>
        <a href="assessment.html" class="nav-link">体质测评</a>
        <a href="advisor.html" class="nav-link">AI顾问</a>
        <a href="poster.html" class="nav-link active">节气海报</a>
        <a href="ingredients.html" class="nav-link">食材图鉴</a>
        <a href="recipes.html" class="nav-link">食谱生成</a>
        <a href="account.html" class="nav-link">个人中心</a>
    </div>

    <div class="container" style="padding-top: 100px; padding-bottom: 60px; min-height: 100vh;">
        
        <div class="base-card" style="padding: 50px; text-align: center; max-width: 800px; margin: 0 auto; position: relative; overflow: hidden;">
            <div style="position: relative; z-index: 2;">
                <h2 style="font-size: 2.5rem; color: var(--primary-color); margin-bottom: 20px; font-family: var(--font-serif);">
                    <i class="fas fa-paint-brush"></i> AI 城市养生海报
                </h2>
                <p style="color: var(--text-secondary); margin-bottom: 40px; font-size: 1.1rem;">
                    输入您所在的城市，AI 将结合今日节气与当地天气，为您绘制专属的二十四节气养生海报。
                </p>
                
                <div style="max-width: 600px; margin: 0 auto; display: flex; gap: 15px; justify-content: center;">
                    <input type="text" id="posterAreaInput" placeholder="例如：北京、上海、杭州..." 
                        style="flex: 1; padding: 15px 25px; border-radius: 50px; border: 1px solid #ddd; outline: none; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                    <button onclick="generatePoster()" id="posterBtn" class="btn-primary" style="padding: 15px 40px; font-size: 1.1rem;">
                        立即生成
                    </button>
                </div>
                
                <div style="margin-top: 20px;">
                     <button onclick="showPosterHistory()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; text-decoration: underline;">
                        <i class="fas fa-history"></i> 查看历史记录
                    </button>
                </div>

                <!-- Result Area -->
                <div id="posterResult" style="margin-top: 50px; display: none; animation: fadeIn 0.5s;">
                    <div id="posterLoading" style="color: var(--primary-color);">
                        <!-- SVG Animation Placeholder -->
                        <svg width="100" height="100" viewBox="0 0 100 100" style="margin: 0 auto;">
                            <circle cx="50" cy="50" r="40" stroke="currentColor" stroke-width="4" fill="none" stroke-dasharray="250" stroke-dashoffset="0">
                                <animate attributeName="stroke-dashoffset" from="250" to="0" dur="2s" repeatCount="indefinite" />
                            </circle>
                            <path d="M30 50 L45 65 L70 35" stroke="currentColor" stroke-width="4" fill="none" stroke-dasharray="100" stroke-dashoffset="100">
                                <animate attributeName="stroke-dashoffset" from="100" to="0" dur="1s" begin="0.5s" fill="freeze" />
                            </path>
                        </svg>
                        <p style="margin-top: 20px; font-weight: 500;">AI 正在绘制中，请稍候...</p>
                    </div>
                    
                    <div id="posterImageContainer" style="display: none;">
                        <img id="posterImage" src="" alt="Generated Poster" style="max-width: 100%; border-radius: 20px; box-shadow: 0 20px 50px rgba(107, 144, 128, 0.2); margin-bottom: 20px;">
                        <div>
                            <a id="downloadLink" href="#" download="poster.png" class="btn-primary" style="padding: 12px 30px; background: var(--gold-accent); color: #fff;">
                                <i class="fas fa-download"></i> 下载海报
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Decoration -->
            <div style="position: absolute; top: -100px; right: -100px; width: 300px; height: 300px; background: var(--primary-color); opacity: 0.05; border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -50px; left: -50px; width: 200px; height: 200px; background: var(--gold-accent); opacity: 0.1; border-radius: 50%;"></div>
        </div>
    </div>

    <script>
        function toggleMobileMenu() {
            const drawer = document.querySelector('.mobile-drawer');
            const overlay = document.querySelector('.mobile-overlay');
            drawer.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        async function generatePoster() {
            const city = document.getElementById('posterAreaInput').value || "北京";
            const resultDiv = document.getElementById('posterResult');
            const loadingDiv = document.getElementById('posterLoading');
            const imgContainer = document.getElementById('posterImageContainer');
            const img = document.getElementById('posterImage');
            const downloadLink = document.getElementById('downloadLink');
            const btn = document.getElementById('posterBtn');
            
            resultDiv.style.display = 'block';
            loadingDiv.style.display = 'block';
            imgContainer.style.display = 'none';
            btn.disabled = true;
            btn.innerHTML = '生成中...';
            
            try {
                const response = await fetch('/api/generate-poster', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ area: city })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '生成失败');
                }

                loadingDiv.style.display = 'none';
                imgContainer.style.display = 'block';
                img.src = data.imageUrl;
                downloadLink.href = data.imageUrl;
            } catch (error) {
                console.error(error);
                loadingDiv.innerHTML = `<p style="color: red; padding: 20px;">生成失败: ${error.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '立即生成';
            }
        }
        
        function showPosterHistory() {
            alert("历史记录功能开发中...");
        }

        // Check for auto-generate param
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('auto_generate') === 'true') {
                generatePoster();
            }
        });
    </script>
</body>
</html>
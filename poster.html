<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>养生海报生成 - AI溯源智养</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <script src="main.js"></script>
</head>
<body>

    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-leaf"></i> 溯源智养
            </div>
            <div class="mobile-menu-btn" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">首页</a>
                <a href="assessment.html" class="nav-link">体质测评</a>
                <a href="plan.html" class="nav-link">滋补计划</a>
                <a href="advisor.html" class="nav-link">AI顾问</a>
                <a href="poster.html" class="nav-link active">节气海报</a>
                <a href="ingredients.html" class="nav-link">食材图鉴</a>
                <a href="recipes.html" class="nav-link">食谱生成</a>
                <a href="account.html" class="nav-link">个人中心</a>
            </div>
        </div>
    </nav>

    <!-- 移动端侧边栏 -->
    <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>
    <div class="mobile-drawer">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div class="logo" style="font-size: 1.2rem;"><i class="fas fa-leaf"></i> 溯源智养</div>
            <div onclick="toggleMobileMenu()" style="font-size: 1.5rem; color: #666;"><i class="fas fa-times"></i></div>
        </div>
        <a href="index.html" class="nav-link">首页</a>
        <a href="assessment.html" class="nav-link">体质测评</a>
        <a href="advisor.html" class="nav-link">AI顾问</a>
        <a href="poster.html" class="nav-link active">节气海报</a>
        <a href="recipes.html" class="nav-link">食谱生成</a>
        <a href="account.html" class="nav-link">个人中心</a>
    </div>

    <div class="container animate-in" style="padding-top: 100px; padding-bottom: 60px; min-height: 100vh;">
        
        <div class="base-card" style="padding: 50px; text-align: center; max-width: 800px; margin: 0 auto; position: relative; overflow: hidden;">
            
            <!-- Solar Term Info Card -->
            <div class="solar-info-card" style="background: linear-gradient(135deg, #8BC34A 0%, #689F38 100%); color: white; border-radius: 16px; padding: 25px; text-align: left; margin-bottom: 40px; box-shadow: 0 10px 25px rgba(104, 159, 56, 0.2); position: relative; overflow: hidden;">
                <div style="position: relative; z-index: 2;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h3 style="margin: 0; font-size: 1.5rem;">今日节气：大雪</h3>
                            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">十一月节，至此而雪盛矣。</p>
                        </div>
                        <i class="fas fa-snowflake" style="font-size: 2.5rem; opacity: 0.8;"></i>
                    </div>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 8px; font-size: 0.9rem;">
                            <i class="fas fa-check-circle"></i> 宜：温阳 · 润燥
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 8px; font-size: 0.9rem;">
                            <i class="fas fa-times-circle"></i> 忌：生冷 · 过劳
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 8px; font-size: 0.9rem;">
                            <i class="fas fa-utensils"></i> 适合：羊肉、红薯、栗子
                        </div>
                    </div>
                </div>
                <i class="fas fa-mountain" style="position: absolute; right: -20px; bottom: -30px; font-size: 8rem; opacity: 0.1;"></i>
            </div>

            <div style="position: relative; z-index: 2;">
                <h2 style="font-size: 2.5rem; color: var(--primary-color); margin-bottom: 20px; font-family: var(--font-serif);">
                    <i class="fas fa-paint-brush"></i> AI 城市养生海报
                </h2>
                <p style="color: var(--text-secondary); margin-bottom: 40px; font-size: 1.1rem;">
                    输入您所在的城市，AI 将结合今日节气与当地天气，为您绘制专属的二十四节气养生海报。
                </p>
                
                <div style="max-width: 600px; margin: 0 auto; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 150px;">
                        <input type="text" id="posterAreaInput" placeholder="输入城市 (如：北京)" 
                            style="width: 100%; padding: 15px 25px; border-radius: 50px; border: 1px solid #ddd; outline: none; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                    </div>
                    <div style="flex: 0 0 120px;">
                        <select id="posterSeasonInput" style="width: 100%; padding: 15px; border-radius: 50px; border: 1px solid #ddd; outline: none; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); background: white; cursor: pointer;">
                            <option value="春季">春季</option>
                            <option value="夏季">夏季</option>
                            <option value="秋季">秋季</option>
                            <option value="冬季">冬季</option>
                        </select>
                    </div>
                    <button onclick="generatePoster()" id="posterBtn" class="btn-primary" style="padding: 15px 40px; font-size: 1.1rem; flex-shrink: 0;">
                        立即生成
                    </button>
                </div>
                
                <div style="margin-top: 20px;">
                     <button onclick="showPosterHistory()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; text-decoration: underline;">
                        <i class="fas fa-history"></i> 查看历史记录
                    </button>
                </div>

                <!-- Result Area -->
                <div id="posterResult" style="margin-top: 50px; display: none; animation: fadeIn 0.5s;">
                    <div id="posterLoading" style="color: var(--primary-color);">
                        <!-- SVG Animation Placeholder -->
                        <svg width="100" height="100" viewBox="0 0 100 100" style="margin: 0 auto;">
                            <circle cx="50" cy="50" r="40" stroke="currentColor" stroke-width="4" fill="none" stroke-dasharray="250" stroke-dashoffset="0">
                                <animate attributeName="stroke-dashoffset" from="250" to="0" dur="2s" repeatCount="indefinite" />
                            </circle>
                            <path d="M30 50 L45 65 L70 35" stroke="currentColor" stroke-width="4" fill="none" stroke-dasharray="100" stroke-dashoffset="100">
                                <animate attributeName="stroke-dashoffset" from="100" to="0" dur="1s" begin="0.5s" fill="freeze" />
                            </path>
                        </svg>
                        <p style="margin-top: 20px; font-weight: 500;">AI 正在绘制中，请稍候...</p>
                    </div>
                    
                    <div id="posterImageContainer" style="display: none;">
                        <img id="posterImage" src="" alt="Generated Poster" style="max-width: 100%; max-height: 55vh; width: auto; object-fit: contain; border-radius: 20px; box-shadow: 0 20px 50px rgba(107, 144, 128, 0.2); margin-bottom: 20px;">
                        <div>
                            <a id="downloadLink" href="#" download="poster.png" class="btn-primary" style="padding: 12px 30px; background: var(--gold-accent); color: #fff;">
                                <i class="fas fa-download"></i> 下载海报
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Decoration -->
            <div style="position: absolute; top: -100px; right: -100px; width: 300px; height: 300px; background: var(--primary-color); opacity: 0.05; border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -50px; left: -50px; width: 200px; height: 200px; background: var(--gold-accent); opacity: 0.1; border-radius: 50%;"></div>
        </div>
    </div>

    <script>
        function toggleMobileMenu() {
            const drawer = document.querySelector('.mobile-drawer');
            const overlay = document.querySelector('.mobile-overlay');
            drawer.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function generatePoster() {
            const city = document.getElementById('posterAreaInput').value.trim();
            const season = document.getElementById('posterSeasonInput').value;
            
            if (!city) {
                alert("请输入城市名称");
                return;
            }

            const prompt = `${city} ${season}`;
            
            const resultDiv = document.getElementById('posterResult');
            const loadingDiv = document.getElementById('posterLoading');
            const imgContainer = document.getElementById('posterImageContainer');
            const img = document.getElementById('posterImage');
            
            resultDiv.style.display = 'block';
            loadingDiv.style.display = 'block';
            imgContainer.style.display = 'none';
            
            // Call Coze API
            if (window.callCozeAPI && typeof CONFIG !== 'undefined') {
                // Pass combined prompt
                callCozeAPI(prompt, CONFIG.POSTER_BOT_ID).then(response => {
                    loadingDiv.style.display = 'none';
                    imgContainer.style.display = 'block';
                    
                    // If response is a URL
                    if (response && response.startsWith('http')) {
                        img.src = response;
                        document.getElementById('downloadLink').href = response;
                        
                        // Save to History
                        savePosterToHistory(response, city, season);
                        
                    } else {
                        // Error handling - No fallback image allowed
                        console.warn("API returned text instead of image:", response);
                        loadingDiv.style.display = 'none';
                        imgContainer.style.display = 'none';
                        alert("海报生成失败：" + (response || "未知错误"));
                    }
                })
                .catch(err => {
                    loadingDiv.style.display = 'none';
                    imgContainer.style.display = 'none';
                    alert("海报生成失败：请检查网络或 API 配置");
                    console.error(err);
                });
            } else {
                // Fallback local simulation - Disabled per user request
                loadingDiv.style.display = 'none';
                alert("未配置 AI 服务，无法生成海报。");
            }
        }
        
        function showPosterHistory() {
            window.location.href = 'account.html#tab-posters';
        }
        
        function savePosterToHistory(url, city, season) {
            try {
                const posters = JSON.parse(localStorage.getItem('savedPosters') || '[]');
                const newPoster = {
                    url: url,
                    city: city,
                    season: season,
                    date: new Date().toISOString()
                };
                posters.unshift(newPoster);
                // Limit to 12
                if (posters.length > 12) posters.pop();
                localStorage.setItem('savedPosters', JSON.stringify(posters));
            } catch(e) {
                console.error("Error saving poster history", e);
            }
        }

        // Check for auto-generate param
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('auto_generate') === 'true') {
                generatePoster();
            }
        });
    </script>
</body>
</html>
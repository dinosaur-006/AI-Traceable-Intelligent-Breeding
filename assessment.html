<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中医体质测评 - AI溯源智养</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Page Specific Styles */
        .quiz-container {
            max-width: 1000px;
            margin: 100px auto 60px; /* Top margin for fixed nav */
            background: #FFFFFF;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-soft), var(--shadow-inner);
            overflow: hidden;
            position: relative;
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }

        .quiz-header {
            background: linear-gradient(to bottom, var(--accent-color), #FFFFFF); 
            padding: 40px 50px 30px;
            text-align: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .quiz-title {
            font-family: var(--font-serif);
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .quiz-desc {
            color: var(--text-secondary);
            font-size: 0.95rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Progress Bar */
        .progress-area {
            height: 6px;
            background: #E0E0E0;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.4s ease;
        }

        /* Content */
        .quiz-content {
            padding: 50px;
            flex: 1;
        }

        /* Options */
        .option-card {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border: 1px solid #F0F0F0;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s;
            background: #FAFAFA;
            margin-bottom: 12px;
        }
        .option-card:hover {
            border-color: var(--primary-color);
            background: var(--highlight-color);
            transform: translateY(-2px);
        }
        .option-card.checked {
            border-color: var(--primary-color);
            background: rgba(107, 144, 128, 0.1);
        }
        .radio-indicator {
            width: 18px;
            height: 18px;
            border: 2px solid #CCC;
            border-radius: 50%;
            margin-right: 15px;
            position: relative;
        }
        .option-card.checked .radio-indicator {
            border-color: var(--primary-color);
        }
        .option-card.checked .radio-indicator::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 10px; height: 10px;
            background: var(--primary-color);
            border-radius: 50%;
        }

        .intro-icon { font-size: 4rem; color: var(--primary-color); margin-bottom: 30px; opacity: 0.8; }
    </style>
</head>
<body>

    <!-- Unified Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-leaf"></i> 溯源智养
            </div>
            <div class="mobile-menu-btn" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">首页</a>
                <a href="assessment.html" class="nav-link active">体质测评</a>
                <a href="advisor.html" class="nav-link">AI顾问</a>
                <a href="poster.html" class="nav-link">节气海报</a>
                <a href="ingredients.html" class="nav-link">食材图鉴</a>
                <a href="recipes.html" class="nav-link">食谱生成</a>
                <a href="account.html" class="nav-link">个人中心</a>
            </div>
        </div>
    </nav>

    <!-- Mobile Drawer -->
    <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>
    <div class="mobile-drawer">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div class="logo" style="font-size: 1.2rem;"><i class="fas fa-leaf"></i> 溯源智养</div>
            <div onclick="toggleMobileMenu()" style="font-size: 1.5rem; color: #666;"><i class="fas fa-times"></i></div>
        </div>
        <a href="index.html" class="nav-link">首页</a>
        <a href="assessment.html" class="nav-link active">体质测评</a>
        <a href="advisor.html" class="nav-link">AI顾问</a>
        <a href="poster.html" class="nav-link">节气海报</a>
        <a href="ingredients.html" class="nav-link">食材图鉴</a>
        <a href="recipes.html" class="nav-link">食谱生成</a>
        <a href="account.html" class="nav-link">个人中心</a>
    </div>

    <div class="container">
        <div class="quiz-container">
            <!-- Header -->
            <div class="quiz-header">
                <h1 class="quiz-title">中医体质辨识</h1>
                <p class="quiz-desc">基于《中医体质分类与判定》标准，AI 智能分析您的体质类型</p>
            </div>

            <!-- Progress -->
            <div class="progress-area">
                <div class="progress-fill" id="progressBar"></div>
            </div>

            <!-- Content -->
            <div class="quiz-content" id="quizApp">
                <!-- 1. Intro -->
                <div id="introView" style="text-align: center;">
                    <div class="intro-icon"><i class="fas fa-user-md"></i></div>
                    <h2 style="color: var(--text-main); margin-bottom: 30px;">准备好了吗？</h2>
                    <p style="margin-bottom: 40px; color: var(--text-secondary);">测评约需 3-5 分钟，请根据近三个月的实际感受回答。</p>
                    
                    <div style="margin-bottom: 40px;">
                        <label style="margin-right: 20px;">
                            <input type="radio" name="gender" value="male" checked> 先生
                        </label>
                        <label>
                            <input type="radio" name="gender" value="female"> 女士
                        </label>
                    </div>

                    <button class="btn-primary" onclick="startQuiz()" style="padding: 15px 50px; font-size: 1.1rem;">开始测评</button>
                </div>

                <!-- 2. Question -->
                <div id="questionView" style="display: none;">
                    <div style="margin-bottom: 30px;">
                        <span style="background: var(--highlight-color); color: var(--primary-color); padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.9rem;">
                            问题 <span id="currentQNum">1</span> / <span id="totalQNum">10</span>
                        </span>
                    </div>
                    
                    <h3 id="questionText" style="font-size: 1.3rem; margin-bottom: 30px; line-height: 1.5;"></h3>
                    
                    <div class="options-grid" id="optionsContainer">
                        <!-- Options injected here -->
                    </div>

                    <div style="margin-top: 40px; display: flex; justify-content: space-between;">
                        <button class="btn-outline" onclick="prevQuestion()" id="prevBtn" style="visibility: hidden;">上一题</button>
                        <!-- Auto advance usually, but keeping next for safety or specific UX -->
                    </div>
                </div>

                <!-- 3. Result (Loading) -->
                <div id="loadingView" style="display: none; text-align: center; padding-top: 50px;">
                    <i class="fas fa-circle-notch fa-spin" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 20px;"></i>
                    <h3>AI 正在分析您的体质档案...</h3>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Data
        const questions = [
            { id: 1, text: "您容易疲乏吗？（精神不振、四肢无力）" },
            { id: 2, text: "您容易气短吗？（呼吸短促，接不上气）" },
            { id: 3, text: "您比别人容易怕冷吗？" },
            { id: 4, text: "您手脚发凉吗？" },
            { id: 5, text: "您容易心慌吗？" },
            { id: 6, text: "您的皮肤容易起荨麻疹吗？" },
            { id: 7, text: "您的口唇颜色偏暗吗？" },
            { id: 8, text: "您容易失眠吗？" },
            { id: 9, text: "您容易忘事（健忘）吗？" },
            { id: 10, text: "您容易精神紧张、焦虑不安吗？" }
        ];
        
        let currentIdx = 0;
        const answers = {};

        function toggleMobileMenu() {
            document.querySelector('.mobile-drawer').classList.toggle('active');
            document.querySelector('.mobile-overlay').classList.toggle('active');
        }

        function startQuiz() {
            document.getElementById('introView').style.display = 'none';
            document.getElementById('questionView').style.display = 'block';
            document.getElementById('totalQNum').innerText = questions.length;
            renderQuestion();
        }

        function renderQuestion() {
            const q = questions[currentIdx];
            document.getElementById('currentQNum').innerText = currentIdx + 1;
            document.getElementById('questionText').innerText = q.text;
            document.getElementById('prevBtn').style.visibility = currentIdx === 0 ? 'hidden' : 'visible';
            
            // Update Progress
            const pct = ((currentIdx) / questions.length) * 100;
            document.getElementById('progressBar').style.width = pct + '%';

            // Render Options
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            const options = [
                { val: 1, label: "没有 (根本不)" },
                { val: 2, label: "很少 (有一点)" },
                { val: 3, label: "有时 (有些)" },
                { val: 4, label: "经常 (相当)" },
                { val: 5, label: "总是 (非常)" }
            ];

            options.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'option-card';
                if (answers[q.id] === opt.val) div.classList.add('checked');
                
                div.onclick = () => selectOption(q.id, opt.val);
                
                div.innerHTML = `
                    <div class="radio-indicator"></div>
                    <div class="option-text">${opt.label}</div>
                `;
                container.appendChild(div);
            });
        }

        function selectOption(qId, val) {
            answers[qId] = val;
            if (currentIdx < questions.length - 1) {
                currentIdx++;
                setTimeout(renderQuestion, 200); // Slight delay for feedback
            } else {
                finishQuiz();
            }
        }

        function prevQuestion() {
            if (currentIdx > 0) {
                currentIdx--;
                renderQuestion();
            }
        }

        async function finishQuiz() {
            document.getElementById('questionView').style.display = 'none';
            document.getElementById('loadingView').style.display = 'block';
            document.getElementById('progressBar').style.width = '100%';

            // Prepare prompt
            let prompt = "请根据以下用户对中医体质测评问题的回答，分析其体质类型。请只返回JSON格式数据，不要包含其他文本。格式如下：{\"type\": \"体质名称\", \"score\": 倾向度分数(0-100), \"desc\": \"简短评价\"}\n\n";
            questions.forEach(q => {
                const ansVal = answers[q.id];
                const ansText = ["", "没有", "很少", "有时", "经常", "总是"][ansVal];
                prompt += `问题：${q.text}\n回答：${ansText}\n\n`;
            });

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: prompt,
                        stream: false,
                        bot_id: '7576213925965299762' // AI 体质测评师 ID
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '分析失败');
                }

                let content = data.message;
                // Try to extract JSON from code block if present
                const jsonMatch = content.match(/```json\n([\s\S]*?)\n```/) || content.match(/\{[\s\S]*\}/);
                
                let result;
                if (jsonMatch) {
                    try {
                        result = JSON.parse(jsonMatch[1] || jsonMatch[0]);
                    } catch (e) {
                        console.error("JSON Parse Error", e);
                    }
                }

                if (!result) {
                    // Fallback if AI didn't return valid JSON
                    result = {
                        type: "分析完成",
                        score: 80,
                        desc: content.substring(0, 50) + "...",
                        raw: content
                    };
                }

                result.date = new Date().toISOString();
                localStorage.setItem('ai_health_constitution', JSON.stringify(result));
                
                // Save raw answers for detailed report
                localStorage.setItem('lastAssessment', JSON.stringify({
                    scorePayload: answers, // Save the answers object
                    date: result.date
                }));
                
                // Redirect
                window.location.href = 'account.html';

            } catch (error) {
                console.error(error);
                alert("AI 分析服务暂时不可用，将使用模拟数据。");
                
                // Fallback Mock
                const result = {
                    type: "气虚质 (模拟)",
                    score: 75,
                    date: new Date().toISOString(),
                    desc: "元气不足，疲乏气短 (由于网络原因，此为模拟结果)"
                };
                localStorage.setItem('ai_health_constitution', JSON.stringify(result));
                window.location.href = 'account.html';
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ¡£æ¡ˆ - AIæº¯æºæ™ºå…»</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-form: #1E1E1E;
            --input-border: #333;
            --brand-highlight: #26C6DA; /* æ›´äº®çš„é’ç»¿è‰² */
            --brand-primary-green: #66BB6A; /* æ¸…æ–°æ˜å¿«çš„ç»¿è‰² */
            --accent-orange: #FF9800; /* é«˜äº®è¾…åŠ©è‰²ï¼šäº®æ©™è‰² */
        }

        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%); /* æŸ”å’Œçš„æ·±è‰²æ¸å˜èƒŒæ™¯ */
            margin: 0;
            overflow-x: hidden;
            font-family: var(--font-sans);
            color: #E0E0E0;
        }

        /* ç»ç’ƒæ‹Ÿæ€å¡ç‰‡é€šç”¨æ ·å¼ */
        .glass-panel {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-radius: 20px;
        }

        /* å¸ƒå±€ç»“æ„ */
        #authView {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* ... (Login Styles keep mostly same but adapt to glassmorphism if needed, skipping detailed auth edits for brevity unless requested, focusing on Dashboard) ... */
        /* å·¦ä¾§è§†è§‰åŒº (65%) */
        .visual-side {
            flex: 65;
            position: relative;
            background: #000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 80px;
        }
        .visual-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.6; filter: grayscale(20%) contrast(1.1); }
        .visual-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(0,0,0,0.7), rgba(0,0,0,0.3)); z-index: 1; }
        .visual-content { position: relative; z-index: 2; max-width: 600px; }
        .slogan { font-family: 'Noto Serif SC', serif; font-size: 3.5rem; font-weight: 700; line-height: 1.2; color: #fff; margin-bottom: 20px; text-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .slogan span { color: var(--brand-highlight); }
        .sub-slogan { font-size: 1.1rem; color: #CCC; margin-bottom: 40px; letter-spacing: 1px; }
        .value-props { display: flex; gap: 30px; }
        .value-item { display: flex; align-items: center; gap: 10px; font-size: 0.95rem; color: #EEE; }
        .value-item i { color: var(--brand-highlight); }

        /* å³ä¾§è¡¨å•åŒº (35%) */
        .form-side {
            flex: 35;
            background: rgba(30, 30, 30, 0.95); /* Slight transparency */
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 60px;
            min-width: 400px;
            position: relative;
            box-shadow: -10px 0 30px rgba(0,0,0,0.2);
        }
        .form-header { margin-bottom: 40px; }
        .welcome-text { font-size: 2rem; font-weight: 700; color: #fff; margin-bottom: 10px; }
        .welcome-sub { color: #888; font-size: 0.9rem; }
        .auth-tabs { display: flex; gap: 30px; margin-bottom: 40px; border-bottom: 1px solid #333; }
        .tab-btn { padding-bottom: 12px; background: none; border: none; font-size: 1.1rem; color: #666; cursor: pointer; position: relative; transition: 0.3s; }
        .tab-btn.active { color: #fff; font-weight: 600; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: var(--brand-highlight); }
        .input-group { margin-bottom: 25px; position: relative; }
        .form-input { width: 100%; padding: 12px 0; background: transparent; border: none; border-bottom: 1px solid var(--input-border); color: #fff; font-size: 1rem; transition: 0.3s; border-radius: 0; }
        .form-input:focus { outline: none; border-bottom-color: var(--brand-highlight); }
        .form-input::placeholder { color: #555; transition: 0.3s; }
        .form-input:focus::placeholder { transform: translateY(-20px); font-size: 0.8rem; color: var(--brand-highlight); opacity: 0; }
        .input-hint { font-size: 0.8rem; color: #555; margin-top: 5px; }
        .btn-submit { width: 100%; padding: 16px; background: var(--brand-highlight); color: #121212; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(77, 182, 172, 0.3); }
        .terms-link { font-size: 0.85rem; color: #666; margin-top: 20px; text-align: center; }
        .terms-link a { color: var(--brand-highlight); text-decoration: none; }
        @media (max-width: 900px) { .visual-side { display: none; } .form-side { flex: 100; } }

        /* ================= DASHBOARD STYLES (REDESIGN) ================= */
        .dashboard-container {
            display: none;
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
            box-sizing: border-box;
        }
        
        /* Navbar Optimization */
        .navbar {
            background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 4px 24px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .dash-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;
            padding: 0 10px;
        }
        
        /* Responsive Grid Layout */
        .dash-grid {
            display: grid; 
            grid-template-columns: 320px 1fr; 
            gap: 30px;
            align-items: start;
        }
        @media(max-width: 1024px) { 
            .dash-grid { grid-template-columns: 1fr; } 
            .profile-card { position: static; margin-bottom: 30px; }
            .dashboard-container { padding: 20px; padding-top: 40px; }
        }

        /* Unified Card Style */
        .dash-card {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 30px;
        }
        .dash-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* ================= LEFT: USER PROFILE CARD ================= */
        .profile-card {
            background: rgba(35, 35, 35, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px;
            padding: 40px 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: sticky;
            top: 100px; 
            z-index: 10;
        }
        
        /* Avatar - Badge Style */
        .avatar-area {
            position: relative; width: 120px; height: 120px; margin-bottom: 20px;
        }
        .avatar-area img { 
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover; 
            border: 3px solid rgba(38, 198, 218, 0.3);
            box-shadow: 0 0 20px rgba(38, 198, 218, 0.1);
        }
        .edit-btn-group {
            position: absolute; bottom: 0; right: 0;
        }
        .btn-edit-circle {
            background: var(--brand-highlight); color: #000;
            border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .btn-edit-circle:hover { transform: scale(1.1); background: #fff; }

        .profile-name { font-size: 1.6rem; font-weight: 700; color: #fff; margin: 10px 0 5px; }
        .profile-bio { font-size: 0.9rem; color: #888; margin-bottom: 25px; line-height: 1.4; }

        /* Capsule Stats */
        .capsule-stats {
            display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; width: 100%; margin-bottom: 30px;
        }
        .capsule-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 50px;
            padding: 6px 14px;
            display: flex; align-items: center; gap: 6px;
            font-size: 0.85rem; color: #ccc;
            transition: 0.3s;
        }
        .capsule-item:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.1); }
        .capsule-item i { color: var(--brand-highlight); }
        .capsule-item span { font-weight: 700; color: #fff; }

        /* Dual Action Buttons */
        .profile-actions {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%;
        }
        .btn-action-fill {
            padding: 12px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer;
            background: var(--brand-highlight); color: #000; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.95rem;
        }
        .btn-action-fill:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(38, 198, 218, 0.4); }
        
        .btn-action-outline {
            padding: 12px; border-radius: 12px; border: 2px solid var(--brand-highlight); font-weight: 600; cursor: pointer;
            background: transparent; color: var(--brand-highlight); transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.95rem;
        }
        .btn-action-outline:hover { background: rgba(38, 198, 218, 0.1); }

        /* ================= RIGHT: MAIN REPORT AREA ================= */
        .report-section {
            display: flex; flex-direction: column; gap: 20px;
        }

        /* Core Constitution Card (Main Focus) */
        .constitution-card {
            background: linear-gradient(135deg, #004D40 0%, #2E7D32 100%); /* Deep Green Gradient */
            border-radius: 24px;
            padding: 80px 50px; /* Increased padding for larger size */
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3); /* Enhanced Shadow */
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            min-height: 300px; /* Ensure minimum height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .constitution-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
        }
        
        /* Texture Overlay */
        .constitution-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 24px 24px; opacity: 0.3;
        }
        
        .const-title-badge {
            display: inline-flex; align-items: center; gap: 8px;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);
            padding: 8px 20px; border-radius: 30px; color: rgba(255,255,255,0.9);
            font-size: 1rem; margin-bottom: 30px; position: relative; z-index: 2;
            border: 1px solid rgba(255,255,255,0.2);
            text-transform: uppercase; letter-spacing: 1px;
        }
        
        .const-main-text {
            font-size: 5rem; /* Larger font */
            font-weight: 900; color: #fff; font-family: 'Noto Serif SC', serif;
            margin-bottom: 20px; letter-spacing: 6px; 
            text-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative; z-index: 2;
            line-height: 1.1;
        }
        
        .const-sub-text {
            font-size: 1.3rem; color: rgba(255,255,255,0.9); font-weight: 500; 
            max-width: 700px; margin: 0 auto;
            position: relative; z-index: 2; line-height: 1.6;
        }

        /* Meta Tags below card */
        .report-meta {
            display: flex; justify-content: center; gap: 25px; margin-top: 40px; position: relative; z-index: 2;
        }
        .meta-tag {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
            padding: 10px 20px; border-radius: 12px; color: #eee; font-size: 0.95rem;
            display: flex; align-items: center; gap: 10px; backdrop-filter: blur(5px);
            transition: 0.3s;
        }
        .meta-tag:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }
        .meta-tag i { color: var(--brand-highlight); }

        /* Advice Card (Modular) */
        .advice-card {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px;
            padding: 35px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .advice-header {
            display: flex; align-items: center; gap: 12px; margin-bottom: 25px;
            border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;
        }
        .advice-header h3 { font-size: 1.3rem; font-weight: 700; color: #fff; margin: 0; }
        .advice-header i { color: var(--accent-orange); font-size: 1.3rem; }

        .advice-list { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .advice-item {
            display: flex; gap: 15px; align-items: flex-start;
            background: rgba(255,255,255,0.02); padding: 15px; border-radius: 12px;
            transition: 0.3s;
        }
        .advice-item:hover { background: rgba(255,255,255,0.05); }
        
        .advice-icon {
            color: var(--brand-highlight); font-size: 0.8rem; margin-top: 6px;
        }
        .advice-content {
            color: #ccc; font-size: 1rem; line-height: 1.6;
        }
        .advice-content strong { color: #fff; font-weight: 700; }
        .highlight-action { color: var(--brand-highlight); font-weight: 700; }

        /* Main CTA Button */
        .main-cta-btn {
            display: flex; align-items: center; justify-content: center; width: 100%; max-width: 350px; margin: 0 auto;
            padding: 16px 30px; background: var(--brand-highlight); color: #000;
            font-size: 1.05rem; font-weight: 800; border-radius: 50px; text-decoration: none;
            box-shadow: 0 0 20px rgba(38, 198, 218, 0.4); /* Soft Glow */
            transition: all 0.3s ease;
        }
        .main-cta-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 0 40px rgba(38, 198, 218, 0.6);
        }
        .main-cta-btn i { margin-left: 10px; transition: 0.3s; }
        .main-cta-btn:hover i { transform: translateX(5px); }


        /* Dialog */
        dialog::backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }
        dialog {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            margin: 0; width: 400px; max-width: 90vw;
            background: #252525; color: #fff; border: 1px solid #444; border-radius: 24px; padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .dialog-actions { display: flex; gap: 15px; margin-top: 30px; }
        .btn-cancel { flex: 1; background: #333; color: #fff; border: none; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo"><i class="fas fa-leaf"></i> æº¯æºæ™ºå…»</div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">é¦–é¡µ</a>
                <a href="assessment.html" class="nav-link">ä½“è´¨æµ‹è¯„</a>
                <a href="account.html" class="nav-link active">æˆ‘çš„æ¡£æ¡ˆ</a>
            </div>
        </div>
    </nav>

    <!-- Auth View -->
    <div id="authView">
        <!-- Left Visual -->
        <div class="visual-side">
            <div class="visual-overlay"></div>
            <img src="https://images.unsplash.com/photo-1544367563-12123d895907?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80" 
                 class="visual-bg" 
                 alt="Healthy Lifestyle" 
                 crossorigin="anonymous" 
                 referrerpolicy="no-referrer">
            <div class="visual-content">
                <div class="slogan">
                    "ä¸Šå·¥æ²»<span>æœªç—…</span>ï¼Œ<br>ä¸­å·¥æ²»æ¬²ç—…ã€‚"
                </div>
                <p class="sub-slogan">èåˆå¤æ³•æ™ºæ…§ä¸ç°ä»£ AIï¼Œä¸ºæ‚¨å®šåˆ¶å…¨ç”Ÿå‘½å‘¨æœŸå¥åº·ç®¡ç†æ–¹æ¡ˆã€‚</p>
                <div class="value-props">
                    <div class="value-item"><i class="fas fa-check-circle"></i> åŒºåŸŸæ€§å¥åº·æ•°æ®åˆ†æ</div>
                    <div class="value-item"><i class="fas fa-robot"></i> AI ä¸“å®¶ 24h éšè®¿</div>
                </div>
            </div>
        </div>

        <!-- Right Form -->
        <div class="form-side">
            <div class="form-header">
                <div class="welcome-text">æ¬¢è¿å›å®¶</div>
                <div class="welcome-sub">ç™»å½•ä»¥è®¿é—®æ‚¨çš„ä¸“å±å¥åº·æ¡£æ¡ˆ</div>
            </div>

            <div class="auth-tabs">
                <button class="tab-btn active" onclick="switchTab('login')">ç™»å½•è´¦å·</button>
                <button class="tab-btn" onclick="switchTab('register')">æ³¨å†Œæ–°è´¦å·</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" onsubmit="event.preventDefault(); handleLogin();">
                <div class="input-group">
                    <input type="email" class="form-input" placeholder="é‚®ç®±åœ°å€ / æ‰‹æœºå·" required>
                </div>
                <div class="input-group">
                    <input type="password" class="form-input" placeholder="å¯†ç " required>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 0.9rem;">
                    <label style="color: #888; cursor: pointer;"><input type="checkbox"> è®°ä½æˆ‘</label>
                    <a href="#" style="color: var(--brand-highlight);" onclick="showForgot()">å¿˜è®°å¯†ç ?</a>
                </div>
                <button type="submit" class="btn-submit">ç«‹å³ç™»å½•</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" style="display: none;" onsubmit="event.preventDefault(); handleRegister();">
                <div class="input-group">
                    <input type="text" class="form-input" placeholder="è®¾ç½®æ˜µç§°" required>
                </div>
                <div class="input-group">
                    <input type="email" class="form-input" placeholder="é‚®ç®±åœ°å€" required>
                </div>
                <div class="input-group">
                    <input type="password" class="form-input" id="regPass" placeholder="è®¾ç½®å¯†ç " required>
                    <div class="input-hint">å¯†ç å¼ºåº¦ (è‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—)</div>
                </div>
                <div class="input-group">
                    <input type="password" class="form-input" id="regPassConfirm" placeholder="ç¡®è®¤å¯†ç " required>
                </div>
                <button type="submit" class="btn-submit">ç²¾ç®€æ³¨å†Œ</button>
                <div class="terms-link">
                    æ³¨å†Œå³ä»£è¡¨åŒæ„ <a href="#">æœåŠ¡æ¡æ¬¾</a> å’Œ <a href="#">éšç§æ”¿ç­–</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboardView" class="dashboard-container">
        <header class="dash-header">
            <div>
                <h2 style="margin-bottom: 5px; font-size: 2rem;">æ—©å®‰ï¼Œ<span id="userNameDisplay" style="color: var(--brand-highlight);">User</span></h2>
                <p style="color: #888;">ä»Šå¤©æ˜¯ <span id="currentDate"></span>ï¼Œç¥æ‚¨èº«å¿ƒæ„‰æ‚¦ã€‚</p>
            </div>
            <!-- ç§»åŠ¨åˆ°å¡ç‰‡å†…çš„æç¤ºï¼Œæ­¤å¤„ç§»é™¤æˆ–ä¿ç•™ä¸ºå…¨å±€å¤©æ°”æç¤º -->
        </header>

        <div class="dash-grid">
            <!-- LEFT: User Profile Sidebar -->
            <aside class="profile-card">
                <div class="avatar-area">
                    <img src="https://ui-avatars.com/api/?name=User&background=4DB6AC&color=fff&size=128" id="userAvatar" alt="Avatar">
                    <div class="edit-btn-group">
                         <button class="btn-edit-circle" onclick="toggleEditProfile()" title="ç¼–è¾‘èµ„æ–™"><i class="fas fa-pen"></i></button>
                    </div>
                </div>
                <h3 id="profileName" class="profile-name">æ™ºå…»ç”¨æˆ·</h3>
                <p id="profileBio" class="profile-bio">æš‚æ— ä¸ªæ€§ç­¾å</p>
                
                <div class="capsule-stats">
                    <div class="capsule-item" title="å¹´é¾„">
                        <i class="fas fa-birthday-cake"></i> <span id="userAge">--</span>
                    </div>
                    <div class="capsule-item" title="èº«é«˜">
                        <i class="fas fa-ruler-vertical"></i> <span id="userHeight">--</span>
                    </div>
                    <div class="capsule-item" title="ä½“é‡">
                        <i class="fas fa-weight"></i> <span id="userWeight">--</span>
                    </div>
                </div>

                <div class="profile-actions">
                    <button class="btn-action-fill" onclick="window.location.href='plan.html'">
                        <i class="fas fa-utensils"></i> è†³é£Ÿå»ºè®®
                    </button>
                    <button class="btn-action-outline" onclick="alert('åŠŸèƒ½å¼€å‘ä¸­')">
                        <i class="fas fa-shopping-cart"></i> è´­ç‰©æŒ‡å¼•
                    </button>
                </div>
                
                <!-- NEW: Health Profile Summary -->
                <div style="margin-top: 25px; width: 100%; background: rgba(0,0,0,0.2); border-radius: 16px; padding: 15px; text-align: left;">
                    <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--accent-orange); display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-id-card-alt"></i> å¥åº·ç”»åƒ
                    </h4>
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #ccc; margin-bottom: 8px;">
                        <span>BMI æŒ‡æ•°</span>
                        <span id="userBMI" style="color: #fff; font-weight: 600;">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #ccc; margin-bottom: 8px;">
                        <span>ä½“è„‚ç‡ (ä¼°)</span>
                        <span id="userBodyFat" style="color: #fff; font-weight: 600;">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #ccc; margin-bottom: 8px;">
                        <span>ç¡çœ è¯„åˆ† (AI)</span>
                        <span id="userSleepScore" style="color: #fff; font-weight: 600;">--</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">é¥®é£Ÿåå¥½</div>
                        <div id="dietTags" style="display: flex; flex-wrap: wrap; gap: 5px;">
                            <!-- Tags injected by JS -->
                        </div>
                    </div>
                </div>

                <div style="margin-top: 25px; width: 100%; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center;">
                    <button onclick="showHistory()" style="background:none; border:none; color:#888; cursor:pointer; font-size:0.9rem; display: flex; align-items: center; justify-content: center; gap: 6px; margin: 0 auto;">
                        <i class="fas fa-history"></i> æŸ¥çœ‹å†å²æµ‹è¯„è®°å½•
                    </button>
                </div>

                <button class="btn-submit" style="margin-top: 20px; background: transparent; border: 1px solid #444; color: #666; padding: 10px;" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
            </aside>

            <!-- RIGHT: Main Report Area -->
            <main class="report-section">
                
                <!-- NEW: Weekly Nourishment Tracker (Keep Style) -->
                <div class="dash-card" style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; font-size: 1.2rem; color: #fff; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-calendar-week" style="color: var(--brand-highlight);"></i> æ»‹è¡¥å…»ç”Ÿå‘¨æŠ¥
                        </h3>
                        <div style="background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; color: var(--accent-orange);">
                            <i class="fas fa-fire"></i> è¿ç»­æ‰“å¡ <span id="streakDays">3</span> å¤©
                        </div>
                    </div>

                    <!-- Calendar Strip -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 25px; text-align: center;">
                        <div class="day-item active">
                            <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">å‘¨ä¸€</div>
                            <div style="width: 36px; height: 36px; background: var(--brand-highlight); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto;">3</div>
                            <div style="font-size: 0.7rem; color: var(--brand-highlight); margin-top: 4px;"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="day-item">
                            <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">å‘¨äºŒ</div>
                            <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.1); color: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto;">4</div>
                        </div>
                        <div class="day-item">
                            <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">å‘¨ä¸‰</div>
                            <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.1); color: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto;">5</div>
                        </div>
                        <div class="day-item">
                            <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">å‘¨å››</div>
                            <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.1); color: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto;">6</div>
                        </div>
                        <div class="day-item">
                            <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">å‘¨äº”</div>
                            <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.1); color: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto;">7</div>
                        </div>
                        <div class="day-item">
                            <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">å‘¨å…­</div>
                            <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.1); color: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto;">8</div>
                        </div>
                        <div class="day-item">
                            <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">å‘¨æ—¥</div>
                            <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.1); color: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto;">9</div>
                        </div>
                    </div>

                    <!-- Today's Tasks & Dos/Donts -->
                    <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px;">
                        <!-- Tasks -->
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 16px;">
                            <div style="font-size: 0.9rem; color: #ccc; margin-bottom: 10px; display: flex; justify-content: space-between;">
                                <span>ä»Šæ—¥ä»»åŠ¡</span>
                                <span style="color: var(--brand-highlight);">å®Œæˆç‡ 0%</span>
                            </div>
                            <div class="task-list-mini">
                                <div class="task-item" style="padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <input type="checkbox" id="trackWater" onchange="updateProgress()">
                                    <label for="trackWater" style="font-size: 0.9rem; margin-left: 10px;">ğŸ’§ é¥®æ°´ 2000ml</label>
                                </div>
                                <div class="task-item" style="padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <input type="checkbox" id="trackSleep" onchange="updateProgress()">
                                    <label for="trackSleep" style="font-size: 0.9rem; margin-left: 10px;">ğŸŒ™ ç¡è¶³ 7 å°æ—¶</label>
                                </div>
                                <div class="task-item" style="padding: 10px 0; border-bottom: none;">
                                    <input type="checkbox" id="trackExercise" onchange="updateProgress()">
                                    <label for="trackExercise" style="font-size: 0.9rem; margin-left: 10px;">ğŸ§˜â€â™€ï¸ å…«æ®µé”¦/ç‘œä¼½</label>
                                </div>
                            </div>
                        </div>

                        <!-- Dos & Donts -->
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div style="flex: 1; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 10px;">
                                <div style="background: #10B981; color: #fff; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">å®œ</div>
                                <div style="font-size: 0.9rem; color: #fff;">æ¸©è¡¥ã€æ—©ç¡</div>
                            </div>
                            <div style="flex: 1; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 10px;">
                                <div style="background: #EF4444; color: #fff; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">å¿Œ</div>
                                <div style="font-size: 0.9rem; color: #fff;">ç”Ÿå†·ã€ç†¬å¤œ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 1. Core Constitution Card -->
                <div class="constitution-card" id="constitutionCard">
                    <div id="constitutionContent">
                        <div style="color: #666; font-size: 4rem; margin-bottom: 20px;"><i class="fas fa-clipboard-list"></i></div>
                        <p style="color: #888; font-size: 1.1rem;">å°šæœªå»ºç«‹ä½“è´¨æ¡£æ¡ˆ</p>
                        <p style="color: #555; margin-bottom: 30px;">å®Œæˆæµ‹è¯„åï¼ŒAI å°†ä¸ºæ‚¨ç”Ÿæˆä¸“å±è°ƒç†æ–¹æ¡ˆ</p>
                        <a href="assessment.html" class="main-cta-btn" style="display: inline-flex; width: auto; padding: 14px 40px;">ç«‹å³å¼€å§‹æµ‹è¯„</a>
                    </div>
                </div>

                <!-- 2. Recommendation Card (Dynamic Content Placeholder) -->
                <div id="adviceSection" style="display: none;">
                    <!-- Will be filled by JS -->
                </div>

            </main>
        </div>
        
        <!-- Edit Profile Modal -->
    <dialog id="editProfileDialog">
        <h3 style="margin-bottom: 20px; color: var(--brand-highlight);">ç¼–è¾‘ä¸ªäººèµ„æ–™</h3>
        <form id="profileForm" onsubmit="saveProfile(event)">
            <div class="input-group"><input class="form-input" id="editName" placeholder="æ˜µç§°"></div>
            <div class="input-group"><input class="form-input" id="editAge" type="number" placeholder="å¹´é¾„"></div>
            <div class="input-group"><input class="form-input" id="editHeight" type="number" placeholder="èº«é«˜(cm)"></div>
            <div class="input-group"><input class="form-input" id="editWeight" type="number" placeholder="ä½“é‡(kg)"></div>
            <div class="input-group"><input class="form-input" id="editBio" placeholder="ä¸ªæ€§ç­¾å"></div>
            <div class="dialog-actions">
                <button type="button" class="btn-cancel" onclick="document.getElementById('editProfileDialog').close()">å–æ¶ˆ</button>
                <button type="submit" class="btn-submit" style="margin-top: 0; flex: 1;">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </form>
    </dialog>

    <!-- Forgot Password Dialog -->
    <dialog id="forgotPasswordDialog">
        <h3 style="margin-bottom: 20px; color: var(--brand-highlight);">æ‰¾å›å¯†ç </h3>
        <form onsubmit="handleForgotPassword(event)">
            <div class="input-group">
                <input type="email" class="form-input" id="forgotEmail" placeholder="è¯·è¾“å…¥æ³¨å†Œé‚®ç®±" required>
            </div>
            <div class="dialog-actions">
                <button type="button" class="btn-cancel" onclick="document.getElementById('forgotPasswordDialog').close()">å–æ¶ˆ</button>
                <button type="submit" class="btn-submit" style="margin-top: 0; flex: 1;">å‘é€é‡ç½®é“¾æ¥</button>
            </div>
        </form>
    </dialog>

    <!-- Reset Password Dialog -->
    <dialog id="resetPasswordDialog">
        <h3 style="margin-bottom: 20px; color: var(--brand-highlight);">è®¾ç½®æ–°å¯†ç </h3>
        <form onsubmit="handleResetPassword(event)">
            <div class="input-group">
                <input type="password" class="form-input" id="newPass" placeholder="æ–°å¯†ç " required>
                <div class="input-hint">è‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—</div>
            </div>
            <div class="input-group">
                <input type="password" class="form-input" id="newPassConfirm" placeholder="ç¡®è®¤æ–°å¯†ç " required>
            </div>
            <div class="dialog-actions">
                <button type="submit" class="btn-submit" style="margin-top: 0; flex: 1;">é‡ç½®å¯†ç </button>
            </div>
        </form>
    </dialog>

    <!-- History Dialog -->
    <dialog id="historyDialog" style="width: 500px;">
        <h3 style="margin-bottom: 20px; color: var(--brand-highlight);">å†å²æµ‹è¯„è®°å½•</h3>
        <div id="historyList" style="max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
            <!-- Items injected here -->
        </div>
        <div class="dialog-actions" style="margin-top: 20px;">
            <button type="button" class="btn-submit" onclick="document.getElementById('historyDialog').close()">å…³é—­</button>
        </div>
    </dialog>

    <!-- AI Report View Dialog -->
    <dialog id="aiReportDialog" style="width: 600px;">
        <h3 style="margin-bottom: 20px; color: var(--brand-highlight); display:flex; align-items:center; gap:10px;">
            <i class="fas fa-robot"></i> AI æ·±åº¦åˆ†ææŠ¥å‘Š
        </h3>
        <div style="background:#333; padding:15px; border-radius:10px; margin-bottom:20px;">
            <div style="color:#888; font-size:0.85rem;">ç”Ÿæˆæ—¥æœŸ</div>
            <div style="color:#fff; font-weight:600;" id="reportDate">--</div>
        </div>
        <div id="reportViewContent" style="max-height: 400px; overflow-y: auto; color:#ddd; line-height:1.6; white-space: pre-wrap; background:#1E1E1E; padding:15px; border-radius:10px; border:1px solid #333;">
            
        </div>
        <div class="dialog-actions" style="margin-top:20px;">
            <button type="button" class="btn-submit" onclick="document.getElementById('aiReportDialog').close()">å…³é—­</button>
        </div>
    </dialog>
    </div>

    <script>
        const API_BASE = '/api';
        
        // Constitution Data Map
        const constMap = {
            'A': { name: 'æ°”è™šè´¨', desc: 'å…ƒæ°”ä¸è¶³ï¼Œä¹åŠ›æ°”çŸ­' },
            'B': { name: 'é˜³è™šè´¨', desc: 'é˜³æ°”ä¸è¶³ï¼Œç•å¯’æ€•å†·' },
            'C': { name: 'é˜´è™šè´¨', desc: 'é˜´æ¶²äºå°‘ï¼Œå£ç‡¥å’½å¹²' },
            'D': { name: 'ç—°æ¹¿è´¨', desc: 'ç—°æ¹¿å‡èšï¼Œä½“èƒ–å¤šç—°' },
            'E': { name: 'æ¹¿çƒ­è´¨', desc: 'æ¹¿çƒ­å†…è•´ï¼Œé¢å¢æ²¹å…‰' },
            'F': { name: 'æ°”éƒè´¨', desc: 'æ°”æœºéƒæ»ï¼Œç¥æƒ…æŠ‘éƒ' },
            'G': { name: 'è¡€ç˜€è´¨', desc: 'è¡€è¡Œä¸ç•…ï¼Œè‚¤è‰²æ™¦æš—' },
            'H': { name: 'ç‰¹ç¦€è´¨', desc: 'å…ˆå¤©å¤±å¸¸ï¼Œé€‚åº”åŠ›å¼±' },
            'I': { name: 'å¹³å’Œè´¨', desc: 'é˜´é˜³å¹³è¡¡ï¼Œä½“é­„å¥å£®' }
        };

        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab-btn');
            const loginForm = document.getElementById('loginForm');
            const regForm = document.getElementById('registerForm');

            if(tab === 'login') {
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
                loginForm.style.display = 'block';
                regForm.style.display = 'none';
            } else {
                tabs[0].classList.remove('active');
                tabs[1].classList.add('active');
                loginForm.style.display = 'none';
                regForm.style.display = 'block';
            }
        }

        async function handleLogin() {
            const email = document.querySelector('#loginForm input[type="email"]').value;
            const password = document.querySelector('#loginForm input[type="password"]').value;

            if(!email || !password) return alert('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');

            try {
                const res = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if(!res.ok) throw new Error(data.error);

                localStorage.setItem('token', data.token);
                localStorage.setItem('userProfile', JSON.stringify(data.user.profile)); // Cache
                
                document.getElementById('authView').style.display = 'none';
                document.getElementById('dashboardView').style.display = 'block';
                document.body.style.overflow = 'auto';
                
                loadDashboard();

            } catch (e) {
                alert(e.message);
            }
        }

        async function handleRegister() {
            const nick = document.querySelector('#registerForm input[placeholder="è®¾ç½®æ˜µç§°"]').value;
            const email = document.querySelector('#registerForm input[type="email"]').value;
            const password = document.getElementById('regPass').value;
            const confirm = document.getElementById('regPassConfirm').value;

            if(!nick || !email || !password) return alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
            if(password !== confirm) return alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
            
            // Frontend Password Validation
            const passRe = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}$/;
            if(!passRe.test(password)) {
                return alert('å¯†ç å¼ºåº¦ä¸è¶³ï¼šéœ€è‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—');
            }

            try {
                const res = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email, 
                        password, 
                        nick
                    })
                });
                const data = await res.json();

                if(!res.ok) {
                    throw new Error(data.error);
                }

                alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                switchTab('login');
                document.getElementById('registerForm').reset();

            } catch (e) {
                alert(e.message);
            }
        }

        function handleLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userProfile');
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('authView').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        async function loadDashboard() {
            const token = localStorage.getItem('token');
            if(!token) return handleLogout();

            try {
                // Fetch latest profile
                const res = await fetch(`${API_BASE}/user/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.status === 401 || res.status === 403) return handleLogout();
                
                const data = await res.json();
                const profile = data.profile || {};
                const nick = data.nick;

                // Store history
                userHistory = profile.assessmentHistory || [];

                // Update UI
                const now = new Date();
                document.getElementById('currentDate').textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;
                
                document.getElementById('userNameDisplay').textContent = nick;
                document.getElementById('profileName').textContent = nick;
                document.getElementById('userAge').textContent = profile.age || '--';
                document.getElementById('userHeight').textContent = profile.height || '--';
                document.getElementById('userWeight').textContent = profile.weight || '--';
                document.getElementById('profileBio').textContent = profile.bio || 'æš‚æ— ä¸ªæ€§ç­¾å';
                document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${nick}&background=4DB6AC&color=fff&size=128`;

                // Calculate BMI
                if (profile.height && profile.weight) {
                    const h = profile.height / 100;
                    const bmi = (profile.weight / (h * h)).toFixed(1);
                    document.getElementById('userBMI').textContent = bmi;
                    
                    // Simple Body Fat Estimate (Formula: 1.20 Ã— BMI + 0.23 Ã— Age - 5.4 - 10.8 Ã— (Gender: 1 for men, 0 for women))
                    // Assuming generic/mixed gender for now or add gender field. Let's use a simplified estimate based on BMI.
                    let estBodyFat = (1.2 * bmi + 0.23 * (profile.age || 30) - 5.4).toFixed(1) + '%';
                    document.getElementById('userBodyFat').textContent = estBodyFat;
                }

                // Mock Sleep Score (AI Analysis)
                // In a real app, this would come from profile.sleepAnalysis or similar
                const sleepScore = Math.floor(Math.random() * (95 - 75) + 75); // Random 75-95
                const sleepEl = document.getElementById('userSleepScore');
                if(sleepEl) sleepEl.textContent = sleepScore + ' åˆ†';

                // Mock Diet Tags based on history (or constitution)
                const dietTagsContainer = document.getElementById('dietTags');
                dietTagsContainer.innerHTML = '';
                const mockTags = ['ä½ç³–', 'é«˜è›‹ç™½', 'å¿Œè¾›è¾£']; // In real app, derive from AI analysis
                mockTags.forEach(tag => {
                    const span = document.createElement('span');
                    span.className = 'tag';
                    span.style.fontSize = '0.75rem';
                    span.style.padding = '4px 8px';
                    span.textContent = tag;
                    dietTagsContainer.appendChild(span);
                });

                // Initialize Weekly Tracker
                initWeeklyTracker();

                // Check for AI Report
                if(profile.aiReport) {
                    currentAiReport = profile.aiReport;
                    document.getElementById('aiReportLink').style.display = 'block';
                }

                // Load Assessment (API Priority, then Local)
                try {
                    let assessment = profile.assessment;
                    
                    // Fallback to local storage if not in profile
                    if (!assessment) {
                        const assessmentStr = localStorage.getItem('lastAssessment');
                        if(assessmentStr) assessment = JSON.parse(assessmentStr);
                    }

                    if(assessment && assessment.results) {
                        // Update local storage if we got it from API (to keep in sync)
                        localStorage.setItem('lastAssessment', JSON.stringify(assessment));

                        const contentDiv = document.getElementById('constitutionContent');
                        const mainTypeKey = Object.keys(assessment.results).find(k => assessment.results[k] === 'æ˜¯' || assessment.results[k] === 'åŸºæœ¬æ˜¯');
                        
                        if(mainTypeKey && constMap[mainTypeKey]) {
                            const type = constMap[mainTypeKey];
                            
                            // æ›´æ–°æ ¸å¿ƒä½“è´¨å¡ç‰‡
                            contentDiv.innerHTML = `
                                <div class="const-title-badge">
                                    <i class="fas fa-crown"></i> æ ¸å¿ƒä½“è´¨åˆ†æ
                                </div>
                                <div class="const-main-text">${type.name}</div>
                                <div class="const-sub-text">${type.desc}</div>
                                
                                <div class="report-meta" style="margin-top: 30px;">
                                    <div class="meta-tag"><i class="fas fa-calendar-alt"></i> ${new Date(assessment.date).toLocaleDateString()}</div>
                                    <div class="meta-tag"><i class="fas fa-user-md"></i> AI é¦–å¸­é¡¾é—®</div>
                                </div>
                            `;

                            // æ›´æ–°å»ºè®®åŒºåŸŸ
                            const adviceSection = document.getElementById('adviceSection');
                            adviceSection.style.display = 'block';
                            adviceSection.className = 'advice-card';
                            adviceSection.innerHTML = `
                                <div class="advice-header">
                                    <i class="fas fa-sparkles"></i>
                                    <h3>AI ä¸“å±å®šåˆ¶å»ºè®®</h3>
                                </div>
                                
                                <div class="advice-list">
                                    <div class="advice-item">
                                        <i class="fas fa-circle advice-icon" style="font-size: 8px; margin-top: 10px;"></i>
                                        <div class="advice-content">
                                            <strong class="highlight-action">å‡å°‘</strong> ç”Ÿå†·å¯’å‡‰é£Ÿç‰©çš„æ‘„å…¥ï¼Œå¦‚å†°é¥®ã€ç”Ÿé±¼ç‰‡ç­‰ï¼Œä»¥å…æŸä¼¤è„¾é˜³ã€‚
                                        </div>
                                    </div>
                                    <div class="advice-item">
                                        <i class="fas fa-circle advice-icon" style="font-size: 8px; margin-top: 10px;"></i>
                                        <div class="advice-content">
                                            <strong class="highlight-action">å¢åŠ </strong> ${type.name === 'æ°”è™šè´¨' ? 'é»„èŠªã€å…šå‚' : 'ç™¾åˆã€é“¶è€³'}ç­‰é£Ÿæçš„æ—¥å¸¸æ­é…ï¼Œå»ºè®®æ¯æ—¥ç…²æ±¤é¥®ç”¨ã€‚
                                        </div>
                                    </div>
                                    <div class="advice-item">
                                        <i class="fas fa-circle advice-icon" style="font-size: 8px; margin-top: 10px;"></i>
                                        <div class="advice-content">
                                            æ³¨æ„ç¯å¢ƒé€šé£ï¼Œé¿å…é•¿æœŸå¤„äºæ½®æ¹¿ç¯å¢ƒï¼Œ<strong class="highlight-action">ä¿æŒ</strong> å±…ä½ç¯å¢ƒå¹²ç‡¥æ¸…çˆ½ã€‚
                                        </div>
                                    </div>
                                </div>

                                <a href="recommend.html" class="main-cta-btn">
                                    æŸ¥çœ‹å®Œæ•´è°ƒç†æ–¹æ¡ˆ <i class="fas fa-arrow-right"></i>
                                </a>
                            `;
                        }
                    }
                } catch(e) { console.error(e); }

            } catch (e) {
                console.error(e);
            }
        }

        function initWeeklyTracker() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 (Sun) - 6 (Sat)
            const currentDayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // 0 (Mon) - 6 (Sun)

            // Calculate Monday of the current week
            const monday = new Date(now);
            monday.setDate(now.getDate() - currentDayIndex);

            const dayItems = document.querySelectorAll('.day-item');
            dayItems.forEach((item, idx) => {
                // Calculate date for this day-item
                const date = new Date(monday);
                date.setDate(monday.getDate() + idx);
                const dateNum = date.getDate();
                
                // Update the date number display (2nd child)
                const numDiv = item.children[1];
                if(numDiv) numDiv.textContent = dateNum;

                // Highlight current day
                if(idx === currentDayIndex) {
                    item.classList.add('active');
                    if(numDiv) {
                        numDiv.style.background = 'var(--brand-highlight)';
                        numDiv.style.color = '#000';
                    }
                } else {
                    item.classList.remove('active');
                    if(numDiv) {
                        numDiv.style.background = 'rgba(255,255,255,0.1)';
                        numDiv.style.color = '#ccc';
                    }
                }
            });
            
            // Restore checkbox state from localStorage for today (Simple persistence)
            const todayKey = `tasks_${now.toDateString()}`;
            const savedTasks = JSON.parse(localStorage.getItem(todayKey) || '{}');
            if(savedTasks.water) document.getElementById('trackWater').checked = true;
            if(savedTasks.sleep) document.getElementById('trackSleep').checked = true;
            if(savedTasks.exercise) document.getElementById('trackExercise').checked = true;

            // Initialize streak
            let streak = localStorage.getItem('streakDays') || 3;
            document.getElementById('streakDays').textContent = streak;
            
            updateProgress();
        }

        function updateProgress() {
            const tasks = [
                {id: 'trackWater', key: 'water'},
                {id: 'trackSleep', key: 'sleep'},
                {id: 'trackExercise', key: 'exercise'}
            ];
            let completed = 0;
            const taskState = {};

            tasks.forEach(task => {
                const el = document.getElementById(task.id);
                if(el && el.checked) {
                    completed++;
                    taskState[task.key] = true;
                } else {
                    taskState[task.key] = false;
                }
            });
            
            // Save state
            const now = new Date();
            localStorage.setItem(`tasks_${now.toDateString()}`, JSON.stringify(taskState));

            const percent = Math.round((completed / tasks.length) * 100);
            
            // Update text
            // Find the label "å®Œæˆç‡ 0%"
            const headerDiv = document.querySelector('.task-list-mini').previousElementSibling;
            if(headerDiv) {
                const percentSpan = headerDiv.querySelector('span:last-child');
                if(percentSpan) percentSpan.textContent = `å®Œæˆç‡ ${percent}%`;
            }

            // Update checkmark for today if 100%
             if(percent === 100) {
                 const currentDayItem = document.querySelector('.day-item.active');
                 if(currentDayItem) {
                      // Check if checkmark already exists (it's the 3rd child usually)
                      let checkDiv = currentDayItem.querySelector('.fa-check')?.parentNode;
                      if(!checkDiv) {
                          checkDiv = document.createElement('div');
                          checkDiv.style.fontSize = '0.7rem';
                          checkDiv.style.color = 'var(--brand-highlight)';
                          checkDiv.style.marginTop = '4px';
                          checkDiv.innerHTML = '<i class="fas fa-check"></i>';
                          currentDayItem.appendChild(checkDiv);
                          
                          // Increment streak if not already incremented today
                          const lastStreakDate = localStorage.getItem('lastStreakDate');
                          const todayStr = new Date().toDateString();
                          if(lastStreakDate !== todayStr) {
                              let s = parseInt(localStorage.getItem('streakDays') || 3);
                              s++;
                              localStorage.setItem('streakDays', s);
                              localStorage.setItem('lastStreakDate', todayStr);
                              const streakEl = document.getElementById('streakDays');
                              if(streakEl) streakEl.textContent = s;
                          }
                      }
                 }
             }
        }

        async function saveProfile(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const profileData = {
                nick: document.getElementById('editName').value,
                age: document.getElementById('editAge').value,
                height: document.getElementById('editHeight').value,
                weight: document.getElementById('editWeight').value,
                bio: document.getElementById('editBio').value
            };

            try {
                const res = await fetch(`${API_BASE}/user/profile`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(profileData)
                });
                if(!res.ok) throw new Error('Update failed');
                
                document.getElementById('editProfileDialog').close();
                loadDashboard();
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }
        
        function toggleEditProfile() {
            const dialog = document.getElementById('editProfileDialog');
            // Pre-fill (Optimistic from UI or cache)
            document.getElementById('editName').value = document.getElementById('profileName').textContent;
            dialog.showModal();
        }

        function showForgot() {
            document.getElementById('forgotPasswordDialog').showModal();
        }

        let currentAiReport = null;
        function showAiReport() {
            if(currentAiReport) {
                document.getElementById('reportDate').textContent = new Date(currentAiReport.date).toLocaleString();
                document.getElementById('reportViewContent').textContent = currentAiReport.content;
                document.getElementById('aiReportDialog').showModal();
            }
        }

        let userHistory = [];

        function showHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            
            if(!userHistory || userHistory.length === 0) {
                list.innerHTML = '<p style="color:#666; text-align:center;">æš‚æ— å†å²è®°å½•</p>';
            } else {
                // Sort by date desc
                const sorted = [...userHistory].sort((a,b) => new Date(b.date) - new Date(a.date));
                sorted.forEach(record => {
                    const dateStr = new Date(record.date).toLocaleString();
                    const mainTypeKey = Object.keys(record.results).find(k => record.results[k] === 'æ˜¯' || record.results[k] === 'åŸºæœ¬æ˜¯') || 'I';
                    const typeName = constMap[mainTypeKey]?.name || 'æœªçŸ¥';
                    
                    const item = document.createElement('div');
                    item.style = "background:#333; padding:15px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;";
                    item.innerHTML = `
                        <div>
                            <div style="color:#fff; font-weight:600;">${typeName}</div>
                            <div style="color:#888; font-size:0.8rem;">${dateStr}</div>
                        </div>
                        <button onclick='viewHistoryItem(${JSON.stringify(record)})' style="background:var(--brand-highlight); color:#121212; border:none; border-radius:4px; padding:5px 10px; cursor:pointer; font-size:0.8rem;">æŸ¥çœ‹è¯¦æƒ…</button>
                    `;
                    list.appendChild(item);
                });
            }
            
            document.getElementById('historyDialog').showModal();
        }

        function viewHistoryItem(record) {
            // Close history list
            document.getElementById('historyDialog').close();
            
            // Mock setting it as current to view in the main dashboard area or just alert for now
            // Better: Populate the main constitution card with this historical data temporarily?
            // Or just show alert. User requirement: "æä¾›ç”¨æˆ·å¯æŸ¥è¯¢çš„å†å²æµ‹è¯„è®°å½•"
            // Let's update the main card to show this historical record.
            
            const contentDiv = document.getElementById('constitutionContent');
            const mainTypeKey = Object.keys(record.results).find(k => record.results[k] === 'æ˜¯' || record.results[k] === 'åŸºæœ¬æ˜¯');
            
            if(mainTypeKey && constMap[mainTypeKey]) {
                const type = constMap[mainTypeKey];
                contentDiv.innerHTML = `
                    <div style="border: 1px dashed var(--brand-highlight); padding: 10px; margin-bottom: 10px; border-radius: 8px; color: var(--brand-highlight); font-size: 0.9rem;">
                        <i class="fas fa-history"></i> æ‚¨æ­£åœ¨æŸ¥çœ‹å†å²å¿«ç…§
                    </div>
                    <div class="const-badge">
                        <div class="const-name">${type.name}</div>
                        <div class="const-desc">${type.desc}</div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; text-align:left;">
                        <div style="background:#333; padding:15px; border-radius:10px;">
                            <div style="color:#888; font-size:0.85rem;">æµ‹è¯„æ—¥æœŸ</div>
                            <div style="color:#fff; font-weight:600;">${new Date(record.date).toLocaleDateString()}</div>
                        </div>
                        <div style="background:#333; padding:15px; border-radius:10px;">
                            <div style="color:#888; font-size:0.85rem;">åˆ¤å®šç»“æœ</div>
                            <div style="color:var(--brand-highlight); font-weight:600;">${record.results[mainTypeKey]}</div>
                        </div>
                    </div>
                    <button onclick="loadDashboard()" style="margin-top:15px; background:#444; color:#fff; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; width:100%;">è¿”å›æœ€æ–°çŠ¶æ€</button>
                `;
            }
        }

        async function handleForgotPassword(e) {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            try {
                const res = await fetch(`${API_BASE}/forgot-password`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email})
                });
                const data = await res.json();
                alert(data.message);
                document.getElementById('forgotPasswordDialog').close();
            } catch(e) { alert(e.message); }
        }

        async function handleResetPassword(e) {
            e.preventDefault();
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('resetToken');
            const newPassword = document.getElementById('newPass').value;
            const confirm = document.getElementById('newPassConfirm').value;

            if(newPassword !== confirm) return alert('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´');
            
            // Frontend Password Validation
            const passRe = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}$/;
            if(!passRe.test(newPassword)) {
                return alert('å¯†ç å¼ºåº¦ä¸è¶³ï¼šéœ€è‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—');
            }

            try {
                const res = await fetch(`${API_BASE}/reset-password`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({token, newPassword})
                });
                const data = await res.json();
                if(!res.ok) throw new Error(data.error);
                
                alert(data.message);
                document.getElementById('resetPasswordDialog').close();
                // Clear URL param
                window.history.replaceState({}, document.title, window.location.pathname);
                switchTab('login');
            } catch(e) { alert(e.message); }
        }

        // Check login status on load
        if(localStorage.getItem('token')) {
            document.getElementById('authView').style.display = 'none';
            document.getElementById('dashboardView').style.display = 'block';
            document.body.style.overflow = 'auto';
            loadDashboard();
        }

        // Check reset token on load
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.has('resetToken')) {
            document.getElementById('resetPasswordDialog').showModal();
        }
    </script>
</body>
</html>
